- name: Build Loop
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }} 
        run: |
          mkdir -p grammars
          # Legge dal file languages.txt saltando i commenti (#)
          grep -v '^#' languages.txt | while read repo; do
            echo "--------------------------------------------"
            
            # Gestione sottocartelle (es. typescript:tsx)
            if [[ "$repo" == *":"* ]]; then
              base_repo="${repo%%:*}"
              subdir="${repo##*:}"
              lang_name="$subdir"
            else
              base_repo="$repo"
              subdir=""
              # Estrae il nome pulito (es. tree-sitter-python -> python)
              lang_name=$(basename "$base_repo" | sed 's/tree-sitter-//')
            fi

            echo "üèóÔ∏è Building: $lang_name from $base_repo"

            git clone --depth 1 "https://x-access-token:${GITHUB_TOKEN}@github.com/${base_repo}.git" temp_repo || { echo "‚ùå Clone failed for $base_repo"; continue; }
            
            cd temp_repo
            [[ -n "$subdir" ]] && cd "$subdir"
            
            # --- NUOVO COMANDO 2026 ---
            # tree-sitter build --wasm √® il comando corretto per le versioni recenti
            if tree-sitter build --wasm; then
              # Il file generato di solito si chiama tree-sitter-[lang].wasm o [lang].wasm
              generated_wasm=$(find . -maxdepth 1 -name "*.wasm" | head -n 1)
              if [[ -n "$generated_wasm" ]]; then
                mv "$generated_wasm" "$GITHUB_WORKSPACE/grammars/$lang_name.wasm"
                echo "‚úÖ Success: $lang_name"
              else
                echo "‚ùå .wasm file not found after build for $lang_name"
              fi
            else
              echo "‚ùå Build failed for $lang_name"
            fi
            
            cd "$GITHUB_WORKSPACE"
            rm -rf temp_repo
            
            sleep 1
          done